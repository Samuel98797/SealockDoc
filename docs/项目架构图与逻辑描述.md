# Sealock Doc 项目架构

## 核心架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                    客户端应用                                    │
│            (浏览器、移动应用、桌面客户端)                         │
└────────────────────────────┬────────────────────────────────────┘
                             │
┌────────────────────────────▼────────────────────────────────────┐
│                      API 服务层 (REST/gRPC)                      │
│  /files/upload  /files/download  /repos/commit  /blocks/check    │
└────────────────────────────┬────────────────────────────────────┘
                             │
┌────────────────────────────▼────────────────────────────────────┐
│                    业务逻辑层 (Service)                           │
│  - FileService (上传、下载、同步)                                 │
│  - LibraryService (版本管理)                                     │
│  - AuthService (权限控制)                                        │
└────────┬──────────────────────┬──────────────────────┬───────────┘
         │                      │                      │
    ┌────▼──────────┐    ┌─────▼─────────┐    ┌──────▼─────────┐
    │  BlockStore   │    │  Repositories │    │    Chunker     │
    │  (块存储)     │    │   (元数据)    │    │   (分块器)     │
    └────┬──────────┘    │               │    └────────────────┘
         │               │               │
    ┌────┴─┬───────────┐ │    ┌──────────▼──────────┐
    │      │           │ │    │  PostgreSQL DB     │
    │ ┌────▼────────┐  │ │    │  ┌────────────────┐│
    │ │ LocalBlock  │  │ │    │  │ Files          ││
    │ │ Store (DEV) │  │ │    │  │ Blocks         ││
    │ └─────────────┘  │ │    │  │ Libraries      ││
    │                  │ │    │  │ LibraryVersion ││
    │ ┌────────────┐   │ │    │  └────────────────┘│
    │ │Redis Cache │◄──┘ │    └────────────────────┘
    │ │(热块加速)  │     │
    │ └────────────┘     │    ┌────────────────────┐
    └────────────────────┘    │   Redis (缓存)     │
                              │ ┌────────────────┐ │
                              │ │ block:hash123  │ │
                              │ │ block:hash456  │ │
                              │ │ ...            │ │
                              │ └────────────────┘ │
                              └────────────────────┘
```

## 核心概念

### 1. 内容寻址存储 (CAS)
文件不按文件名存储，而是拆分为固定大小（或 CDC 变长）的块。每个块的唯一标识是其内容的 SHA-256 哈希。

**优势：**
- ✅ 自动去重：相同内容的块只存储一次
- ✅ 秒传：检查块是否存在即可判断是否需要上传
- ✅ 增量同步：只需同步新增或修改的块
- ✅ 数据完整性：每个块都可独立验证

### 2. 元数据分离
数据库仅存储文件结构、权限和块 ID 列表。实际数据块存放在本地存储或分布式存储系统中。

**分离的好处：**
- 📊 数据库轻量化：只存储元数据和引用
- 🚀 块存储可扩展：易于扩展到分布式存储
- 🔒 访问控制精细化：通过 DB 权限控制

### 3. 层级模型

#### Library（资料库）
最高层级，拥有独立的元数据和版本历史。
```
Library
├── Version 1 (Commit)
├── Version 2 (Commit) ← HEAD
└── Version 3 (Commit)
```

#### LibraryVersion（版本/提交）
记录文件树在某一时刻的状态。支持版本回溯和合并。
```
LibraryVersion (Commit)
├── RootHash: "abc123..."
├── Author: "user@example.com"
├── Message: "Update document"
├── ParentCommits: ["parent123..."] (支持多个父节点，用于合并)
└── CreatedAt: 2026-01-07
```

#### File（文件）
由多个块组成，存储块的 ID 列表。
```
File
├── Name: "document.pdf"
├── Hash: "merkle123..." (Merkle 树根哈希)
├── BlockIDs: ["block1", "block2", "block3"]
└── Size: 102400
```

#### Block（块）
最小存储单位，内容寻址。
```
Block
├── Hash: "a1b2c3d4e5..." (SHA-256)
├── Size: 8192
├── RefCount: 3 (被 3 个文件引用)
└── Data: [binary data]
```

## 数据流

### 📤 上传流程

```
用户上传文件
    ↓
[Chunker] 分块
    ├─ 固定大小块（FixedSizeChunker）8MB
    └─ 内容定义块（CDCChunker）变长 2-8MB
    ↓
[BlockStore] 存储块
    ├─ 本地存储（LocalBlockStore）
    └─ Redis 缓存（RedisBlockCache）
    ↓ (同时)
[FileRepository] 记录文件元数据
    ├─ 文件名、大小
    ├─ 块 ID 列表
    └─ 文件 Merkle hash
    ↓
[BlockRepository] 更新块元数据
    ├─ 增加引用计数
    └─ 记录首次上传时间
    ↓
✅ 上传完成，返回文件 hash
```

### 📥 下载流程

```
用户请求下载（提供文件 hash）
    ↓
[FileRepository] 查询文件元数据
    ├─ 检查权限
    └─ 获取块 ID 列表
    ↓
[BlockStore] 并行获取所有块
    ├─ Redis 缓存（命中？直接返回）
    └─ 本地存储（未命中？读取 + 更新缓存）
    ↓
[Reassembler] 拼接块
    ├─ 按顺序组合块数据
    └─ 计算完整性 Merkle hash
    ↓
[Verifier] 验证完整性
    ├─ 计算结果 hash
    ├─ 对比存储的 hash
    └─ ✅ 通过 → 返回文件；❌ 失败 → 抛出错误
```

### 🔄 增量同步流程

```
客户端有旧版本，需要同步新版本
    ↓
[DeltaCalculator] 对比块列表
    ├─ 客户端: [block1, block2, block3]
    ├─ 服务端: [block1, block2_new, block3, block4]
    └─ 增量: [block2_new, block4]
    ↓
[BlockStore] 只上传新增块
    ├─ block2_new（修改的块）
    └─ block4（新增的块）
    ↓ (节省带宽)
✅ 增量同步完成（只传输差异部分）
```

### 🗑️ 垃圾回收流程

```
文件被删除 / 版本被删除
    ↓
[GarbageCollector] 标记块为孤立
    ├─ 检查块的引用计数
    └─ RefCount = 0 → 标记为垃圾
    ↓
[BlockRepository] 列出孤立块
    ├─ SELECT hash FROM blocks WHERE ref_count = 0
    └─ 返回孤立块列表
    ↓
[BlockStore] 删除孤立块
    ├─ 本地存储：删除文件
    └─ Redis 缓存：删除缓存项
    ↓
✅ 垃圾回收完成，释放存储空间
```

## 存储栈 (Storage Stack)

### 开发环境：local
```
FileService
    ↓
LocalBlockStore (内存存储)
FileRepository (GORM)
    ↓
PostgreSQL (元数据)
```

### 测试环境：local-cached
```
FileService
    ↓
LocalBlockStore ←→ Redis (热块缓存)
FileRepository (GORM)
    ↓
PostgreSQL (元数据)
```

## 性能优化

### 块缓存策略
- 热块（最近 24 小时）存储在 Redis
- 本地块存储
- 自动分级：热→冷→删除

### 数据库索引
```sql
CREATE INDEX idx_block_hash ON blocks(hash);
CREATE INDEX idx_file_library_id ON files(library_id);
CREATE INDEX idx_version_library_id ON library_versions(library_id);
```

### 并行操作
- 块上传：并行存储多个块
- 块下载：并行读取多个块

## 迁移路径

### Phase 1: 开发
```
local → PostgreSQL
```

### Phase 2: 测试
```
local-cached → PostgreSQL + Redis
```

### Phase 3: 生产
```
local-cached → PostgreSQL + Redis
```

### 扩展方案（云存储）
如需集成云存储（如 MinIO、阿里 OSS、Google Cloud Storage），可通过实现 BlockStore 接口来完成：

```go
type BlockStore interface {
    Put(ctx context.Context, hash string, data []byte) error
    Get(ctx context.Context, hash string) ([]byte, error)
    Exists(ctx context.Context, hash string) (bool, error)
    Delete(ctx context.Context, hash string) error
    GetSize(ctx context.Context, hash string) (int64, error)
}
```

此方案保持架构灵活性，可以在任何时刻添加分布式存储支持。

### 数据迁移策略（云存储扩展时）
1. 启动新栈（带云存储）
2. 增量同步数据（对比块哈希）
3. 验证一致性（逐块验证）
4. 灰度切流（10% → 50% → 100%）
5. 下线旧栈（确认稳定后）